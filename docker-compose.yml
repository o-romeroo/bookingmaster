version: "3.8"

# ===========================================
# INFRAESTRUTURA CI/CD - BookingMaster
# ===========================================
# Este arquivo configura toda a infraestrutura para CI/CD:
# - Jenkins (servidor de CI/CD)
# - MariaDB (banco de produção)
# - BookingMaster API (aplicação)
#
# Variáveis necessárias no arquivo .env:
#   - NGROK_AUTHTOKEN
#   - DB_ROOT_PASSWORD
#   - DB_NAME
#   - DB_USER
#   - DB_PASSWORD
# ===========================================

services:
  # ===========================================
  # JENKINS - Servidor CI/CD
  # ===========================================
  jenkins:
    build:
      context: .
      dockerfile: Dockerfile.jenkins
    container_name: jenkins
    restart: unless-stopped
    privileged: true
    user: root
    ports:
      - "8081:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
    networks:
      - bookingmaster-network

  # ===========================================
  # NGROK - Túnel para expor a API na Internet
  # ===========================================
  # Acesse http://localhost:4040 para ver a URL pública
  # Configure NGROK_AUTHTOKEN no arquivo .env
  # A API fica disponível publicamente via ngrok
  # Jenkins permanece acessível apenas localmente (localhost:8081)
  # ===========================================
  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok
    restart: unless-stopped
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    command: http bookingmaster-api:8080 --log=stdout
    ports:
      - "4040:4040"
    networks:
      - bookingmaster-network
    depends_on:
      - backend

  # ===========================================
  # MARIADB - Banco de Dados de Produção
  # ===========================================
  db:
    image: mariadb:11.2
    container_name: bookingmaster-db
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mariadb-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - bookingmaster-network

  # ===========================================
  # BOOKINGMASTER API - Aplicação
  # ===========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: bookingmaster:latest
    container_name: bookingmaster-api
    restart: always
    environment:
      - DATABASE_URL=jdbc:mariadb://bookingmaster-db:3306/${DB_NAME}?createDatabaseIfNotExist=true
      - DATABASE_USERNAME=${DB_USER}
      - DATABASE_PASSWORD=${DB_PASSWORD}
      - PORT=8080
      - SPRING_PROFILES_ACTIVE=prod
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - bookingmaster-network

volumes:
  jenkins_home:
    name: jenkins_home
  mariadb-data:
    name: bookingmaster-mariadb-data

networks:
  bookingmaster-network:
    name: bookingmaster-network
    driver: bridge
